name: Update APT Repository

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  update-repo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-utils gnupg curl jq

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "::error::GPG_PRIVATE_KEY secret is not set!"
            exit 1
          fi
          echo "$GPG_PRIVATE_KEY" > private.key
          echo "Importing key..."
          gpg --batch --import private.key || echo "Import warning ignored."
          rm private.key
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

      - name: Check for updates
        id: check_update
        run: |
          UPSTREAM_REPO="vernesong/mihomo"
          GITHUB_PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          
          # 获取上游最新版本信息
          LATEST_RELEASE=$(curl -s "https://api.github.com/repos/$UPSTREAM_REPO/releases?per_page=1" | jq '.[0]')
          RELEASE_ID=$(echo "$LATEST_RELEASE" | jq -r .id)
          TAG_NAME=$(echo "$LATEST_RELEASE" | jq -r .tag_name)
          PUBLISHED_AT=$(echo "$LATEST_RELEASE" | jq -r .published_at)
          
          echo "Upstream Tag: $TAG_NAME"

          # 获取当前仓库(gh-pages)的在线版本 (通过 curl 获取，而不是读本地文件)
          # 如果获取失败（比如第一次运行），则设为 none
          CURRENT_VERSION_STR=$(curl -sL --fail "$GITHUB_PAGES_URL/human_version.txt" || echo "none")
          
          echo "Current Online Version: $CURRENT_VERSION_STR"
          
          FORCE_UPDATE="${{ github.event.inputs.force_update }}"
          TARGET_VERSION_STR="$TAG_NAME-$PUBLISHED_AT"

          # 对比版本
          if [ "$FORCE_UPDATE" != "true" ] && [ "$CURRENT_VERSION_STR" == "$TARGET_VERSION_STR" ]; then
            echo "::notice::No update needed."
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "::notice::Update triggered!"
          echo "updated=true" >> $GITHUB_OUTPUT
          
          # 准备输出目录 (public 文件夹用于发布)
          mkdir -p public/pool/main/m/mihomo
          mkdir -p public/dists/stable/main/binary-amd64
          mkdir -p public/dists/stable/main/binary-arm64
          mkdir -p public/dists/stable/main/binary-armhf
          
          # 保存版本号到 public 目录
          echo "$RELEASE_ID" > public/release_id.txt
          echo "$TARGET_VERSION_STR" > public/human_version.txt
          
          # 下载 .deb 文件到 public/pool
          echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | endswith(".deb")) | .browser_download_url' | while read url; do
            filename=$(basename "$url")
            echo "Downloading $filename..."
            curl -L -o "public/pool/main/m/mihomo/$filename" "$url"
          done

      - name: Generate APT metadata
        if: steps.check_update.outputs.updated == 'true'
        working-directory: public # 关键：进入 public 目录操作
        run: |
          # 1. 生成 Packages 文件
          cat <<EOF > apt-ftparchive.conf
          Dir {
            ArchiveDir ".";
            CacheDir ".";
          };
          Default {
            Packages::Compress ". gzip bzip2";
            Contents::Compress ". gzip bzip2";
            Nocache "true";
          };
          Tree "dists/stable" {
            Sections "main";
            Architectures "amd64 arm64 armhf";
            BinDirectory "pool/main";
          };
          EOF
          
          apt-ftparchive generate apt-ftparchive.conf
          
          # 兜底：确保 Packages 文件存在
          for arch in amd64 arm64 armhf; do
             PKG_FILE="dists/stable/main/binary-$arch/Packages"
             if [ ! -s "$PKG_FILE" ]; then
                touch "$PKG_FILE"
                gzip -c "$PKG_FILE" > "${PKG_FILE}.gz"
                bzip2 -c "$PKG_FILE" > "${PKG_FILE}.bz2"
             fi
          done

          # 2. 生成 Release 文件
          cat <<EOF > apt-release.conf
          APT::FTPArchive::Release::Origin "Mihomo Unofficial";
          APT::FTPArchive::Release::Label "Mihomo Unofficial";
          APT::FTPArchive::Release::Suite "stable";
          APT::FTPArchive::Release::Codename "stable";
          APT::FTPArchive::Release::Architectures "amd64 arm64 armhf";
          APT::FTPArchive::Release::Components "main";
          APT::FTPArchive::Release::Description "Unofficial Mihomo APT Repository";
          EOF

          apt-ftparchive -c apt-release.conf release dists/stable > dists/stable/Release
          
          # 3. GPG 签名
          rm -f dists/stable/Release.gpg dists/stable/InRelease
          KEY_ID=$(gpg --list-secret-keys --with-colons | grep '^sec:' | cut -d':' -f5 | head -n 1)
          
          gpg --batch --yes --passphrase="${{ secrets.GPG_PASSPHRASE }}" --pinentry-mode loopback --default-key "$KEY_ID" -abs -o dists/stable/Release.gpg dists/stable/Release
          gpg --batch --yes --passphrase="${{ secrets.GPG_PASSPHRASE }}" --pinentry-mode loopback --default-key "$KEY_ID" --clearsign -o dists/stable/InRelease dists/stable/Release

      - name: Create Web Assets
        if: steps.check_update.outputs.updated == 'true'
        working-directory: public
        run: |
          touch .nojekyll
          # 简单的索引页生成 (这里省略了复杂的 HTML，保持核心功能)
          echo "<html><body><h1>Mihomo APT Repo</h1><p>Latest: $(cat human_version.txt)</p></body></html>" > index.html

      - name: Deploy to GitHub Pages (Orphan Branch)
        if: steps.check_update.outputs.updated == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public   # 只发布 public 目录里的内容
          publish_branch: gh-pages # 发布到 gh-pages 分支
          force_orphan: true      # 【核心】每次都强制覆盖历史，只保留最后一次提交
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "Update repository: ${{ steps.check_update.outputs.version }}"